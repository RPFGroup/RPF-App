# 🗄️ دليل نظام إدارة قاعدة البيانات الاحترافي

## 📋 نظرة عامة

تم إنشاء نظام احترافي ومتكامل لإدارة قاعدة البيانات في Supabase، يوفر:

### ✨ الميزات الرئيسية:
1. **📥 النسخ الاحتياطي الكامل** - نسخ احتياطي لكل الجداول في ملف واحد
2. **📤 الاستعادة الذكية** - استعادة من النسخة الاحتياطية مع خيارات متقدمة
3. **🗂️ إدارة منفردة للجداول** - التحكم الكامل في كل جدول على حدة
4. **📊 الإحصائيات الفورية** - معلومات تفصيلية عن كل جدول
5. **🔐 نظام صلاحيات متقدم** - Admin فقط يمكنه الوصول

---

## 🚀 الوصول إلى النظام

### المتطلبات:
- ✅ دور المستخدم: **Admin** فقط
- ✅ تسجيل الدخول إلى التطبيق
- ✅ اتصال نشط بـ Supabase

### الوصول:
```
1. اذهب إلى: Settings (⚙️)
2. اختر تاب: "🗄️ Database Management"
3. ستظهر لوحة إدارة قاعدة البيانات الكاملة
```

**ملاحظة:** إذا لم تكن Admin، لن تظهر لك هذه القائمة.

---

## 📊 الجداول المتاحة في النظام

### 1. 🏗️ Projects (المشاريع)
- **الوصف:** جدول المشاريع الرئيسي
- **الحجم المتوقع:** متوسط إلى كبير
- **حساس:** لا
- **الأعمدة:** Project Code, Name, Type, Division, etc.

### 2. 📋 BOQ Activities (الأنشطة)
- **الوصف:** جدول أنشطة BOQ
- **الحجم المتوقع:** كبير
- **حساس:** لا
- **الأعمدة:** Activity Name, Planned Units, Actual Units, Progress, etc.

### 3. 📊 KPI Records (سجلات KPI)
- **الوصف:** جدول KPIs الموحد (Planned & Actual)
- **الحجم المتوقع:** كبير جداً
- **حساس:** لا
- **الأعمدة:** Activity Name, Quantity, Input Type, Target Date, etc.

### 4. 👥 Users (المستخدمون)
- **الوصف:** جدول المستخدمين
- **الحجم المتوقع:** صغير
- **حساس:** ⚠️ **نعم - بيانات حساسة**
- **الأعمدة:** Email, Full Name, Role, Division

### 5. 🏢 Divisions (الأقسام)
- **الوصف:** جدول الأقسام
- **الحجم المتوقع:** صغير جداً (4-10 صفوف)
- **حساس:** لا
- **الأعمدة:** Name, Code, Description, Usage Count

### 6. 📁 Project Types (أنواع المشاريع)
- **الوصف:** جدول أنواع المشاريع
- **الحجم المتوقع:** صغير جداً (6-15 صفوف)
- **حساس:** لا
- **الأعمدة:** Name, Code, Description, Usage Count

### 7. 💰 Currencies (العملات)
- **الوصف:** جدول العملات
- **الحجم المتوقع:** صغير جداً (3-10 صفوف)
- **حساس:** لا
- **الأعمدة:** Code, Name, Symbol, Exchange Rate

### 8. 🎯 Activities Database (قاعدة الأنشطة)
- **الوصف:** قاعدة بيانات الأنشطة المتاحة
- **الحجم المتوقع:** متوسط (50-200 صفوف)
- **حساس:** لا
- **الأعمدة:** Name, Division, Unit, Category, Usage Count

### 9. ⚙️ Company Settings (إعدادات الشركة)
- **الوصف:** جدول إعدادات الشركة
- **الحجم المتوقع:** صغير جداً (1-5 صفوف)
- **حساس:** لا
- **الأعمدة:** Company Name, Slogan, Logo URL

---

## 🎯 الواجهة الرئيسية (Overview)

### إحصائيات سريعة:
```
📊 Total Tables: 9
📊 Total Rows: X,XXX
📊 Today's Date: Oct 9, 2025
```

### الإجراءات السريعة:
1. **💾 Create Full Backup** - إنشاء نسخة احتياطية كاملة
2. **🗂️ Manage Tables** - إدارة الجداول منفردة

### جدول الجداول:
- عرض سريع لكل الجداول
- عدد الصفوف لكل جدول
- الحجم التقديري

---

## 💾 النسخ الاحتياطي الكامل

### 📥 إنشاء نسخة احتياطية:

#### الخطوات:
```
1. اذهب إلى تاب "Create Backup"
2. اضغط على "Download Full Backup"
3. انتظر حتى يتم إنشاء النسخة
4. سيتم تنزيل ملف JSON تلقائياً
```

#### ما يتم نسخه:
- ✅ جميع الجداول التسعة
- ✅ كل الصفوف في كل جدول
- ✅ Metadata (تاريخ، إصدار، إحصائيات)
- ✅ Version info للتوافق

#### صيغة الملف:
```json
{
  "version": "1.0.0",
  "timestamp": "2025-10-09T10:30:00.000Z",
  "tables": {
    "Planning Database - ProjectsList": [...],
    "Planning Database - BOQ Rates": [...],
    "Planning Database - KPI": [...],
    ...
  },
  "metadata": {
    "createdAt": "2025-10-09T10:30:00.000Z",
    "totalTables": 9,
    "totalRows": 5432,
    "appVersion": "1.0.0",
    "description": "Full database backup"
  }
}
```

#### اسم الملف:
```
database_backup_2025-10-09.json
```

### 📤 استعادة من نسخة احتياطية:

#### الخطوات:
```
1. اذهب إلى تاب "Restore"
2. اختر ملف النسخة الاحتياطية (.json)
3. اضغط "Load Backup File"
4. راجع معلومات النسخة:
   - تاريخ الإنشاء
   - عدد الجداول
   - عدد الصفوف
5. اختر وضع الاستعادة:
   - Append: إضافة للبيانات الموجودة
   - Replace: حذف البيانات القديمة واستبدالها ⚠️
6. اضغط "Restore Database"
7. تأكيد العملية
```

#### ⚠️ تحذيرات مهمة:
- **وضع Replace**: سيحذف **كل** البيانات الموجودة في الجداول المحددة!
- **لا يمكن التراجع**: بعد الحذف، لا يمكن استعادة البيانات القديمة
- **تأكد من النسخة**: تحقق من تاريخ وإصدار النسخة الاحتياطية
- **النسخ الاحتياطي أولاً**: قم بعمل نسخة احتياطية قبل الاستعادة

#### وضع Append (الآمن):
- ✅ يحتفظ بالبيانات الموجودة
- ✅ يضيف بيانات جديدة
- ⚠️ قد يسبب تكرار البيانات إذا كانت موجودة

#### وضع Replace (خطر):
- ⚠️ يحذف كل البيانات أولاً
- ✅ ثم يضيف البيانات الجديدة
- ❌ **لا يمكن التراجع!**

---

## 🗂️ إدارة الجداول المنفردة

### الوصول:
```
اذهب إلى تاب "Manage Tables"
```

### لكل جدول، ستجد:

#### 📊 الإحصائيات:
- **Total Rows**: عدد الصفوف
- **Estimated Size**: الحجم التقديري
- **Last Updated**: آخر تحديث

#### 📥 تصدير البيانات:
```
1. Export JSON - تصدير كملف JSON
2. Export CSV - تصدير كملف CSV (Excel compatible)
```

**الاستخدام:**
- للتحليل في Excel
- للنسخ الاحتياطي الجزئي
- لمشاركة البيانات

#### 📄 تنزيل Template:
```
زر "Download Empty Template (CSV)"
```

**ما تحصل عليه:**
- ملف CSV فارغ
- يحتوي على كل أسماء الأعمدة
- جاهز للملء وإعادة الرفع

**الاستخدام:**
- لإضافة بيانات جديدة بكميات كبيرة
- للتأكد من أسماء الأعمدة الصحيحة
- لتدريب الموظفين

#### 📤 استيراد البيانات:
```
1. اختر ملف (JSON أو CSV)
2. اختر الوضع:
   - Append: إضافة
   - Replace: استبدال
3. اضغط "Import"
4. تأكيد العملية
```

**صيغ مدعومة:**
- ✅ JSON (مصدر من Export JSON)
- ✅ CSV (Excel, Google Sheets, etc.)

**ملاحظات:**
- يجب أن تتطابق أسماء الأعمدة
- التنسيق يجب أن يكون صحيح
- للـ CSV: استخدم UTF-8 encoding

#### 💾 نسخة احتياطية للجدول:
```
زر "Create Backup"
```

**ما تحصل عليه:**
- نسخة احتياطية لهذا الجدول فقط
- ملف JSON بنفس صيغة النسخة الكاملة
- يمكن استعادته لاحقاً

#### 🗑️ مسح كل البيانات (Danger Zone):

**⚠️ خطر! استخدم بحذر شديد!**

```
زر "Clear All Data" (أحمر)
```

**ماذا يحدث:**
- يحذف **كل** الصفوف في الجدول
- **لا يمكن التراجع!**
- الجدول نفسه يبقى موجود (فقط البيانات تحذف)

**متى تستخدمه:**
- عند البدء من جديد
- عند إعادة استيراد بيانات جديدة كلياً
- للتجارب والاختبارات

**⚠️ لا تستخدمه على:**
- جدول Users (بيانات حساسة - مخفي)
- جداول الإنتاج (production data)
- بدون نسخة احتياطية!

**الحماية:**
- يطلب تأكيد مزدوج
- يعرض عدد الصفوف التي ستحذف
- زر أحمر واضح

---

## 🔒 الأمان والحماية

### نظام الصلاحيات:
```
✅ Admin: وصول كامل
❌ Manager: لا يمكن الوصول
❌ Engineer: لا يمكن الوصول
❌ Viewer: لا يمكن الوصول
```

### الحماية من الحذف:
1. **تأكيد مزدوج** لكل عملية خطرة
2. **رسائل تحذير** واضحة
3. **ألوان تحذيرية** (أحمر للخطر)
4. **معلومات تفصيلية** قبل التأكيد

### البيانات الحساسة:
- **جدول Users** لا يظهر له زر "Clear All Data"
- حماية إضافية للبيانات الحساسة
- التحقق من الصلاحيات على كل عملية

### Audit Trail:
- كل العمليات يتم تسجيلها في console
- يمكن تتبع من قام بماذا
- Timestamps على كل عملية

---

## 📝 أمثلة عملية

### مثال 1: نسخ احتياطي يومي
```
الخطوات:
1. كل يوم في نهاية العمل
2. اذهب إلى Database Management
3. Create Backup → Download Full Backup
4. حفظ الملف في مكان آمن (Google Drive, Dropbox)
5. تسمية الملف: backup_2025-10-09.json
```

### مثال 2: إضافة مشاريع جديدة بالجملة
```
الخطوات:
1. اذهب إلى Manage Tables
2. اختر Projects
3. Download Empty Template
4. افتح الملف في Excel
5. املأ البيانات (Project Code, Name, Type, etc.)
6. احفظ كـ CSV (UTF-8)
7. ارجع للنظام
8. اختر الملف
9. Mode: Append
10. Import
```

### مثال 3: تنظيف بيانات الاختبار
```
الخطوات:
1. Create Full Backup أولاً! ⚠️
2. اذهب إلى Manage Tables
3. اختر الجدول المطلوب (مثل KPI)
4. Clear All Data
5. تأكيد الحذف
6. ابدأ من جديد
```

### مثال 4: نقل البيانات لخادم جديد
```
الخطوات:
1. في الخادم القديم:
   - Create Full Backup
   - Download الملف
2. في الخادم الجديد:
   - تأكد من إنشاء الجداول
   - اذهب إلى Restore
   - اختر ملف النسخة
   - Mode: Append (إذا كانت الجداول فارغة)
   - Restore
```

### مثال 5: استعادة بعد خطأ
```
السيناريو: تم حذف بيانات بالخطأ

الخطوات:
1. لا تقلق! لديك نسخة احتياطية
2. اذهب إلى Restore
3. اختر آخر نسخة احتياطية
4. Load Backup File
5. راجع التاريخ (تأكد أنها قبل الخطأ)
6. Mode: Replace (لاستبدال البيانات الخاطئة)
7. تأكيد الاستعادة
8. ✅ تم استعادة البيانات!
```

---

## 🚨 استكشاف الأخطاء

### مشكلة: "Access Denied"
**الحل:**
- تأكد أنك Admin
- تحقق من role في جدول users
- تسجيل خروج ودخول مرة أخرى

### مشكلة: "Failed to backup table"
**الحل:**
- تحقق من اتصال الإنترنت
- تحقق من Supabase connection
- راجع console للأخطاء
- جرب جدول واحد أولاً

### مشكلة: "Invalid backup file"
**الحل:**
- تأكد أن الملف .json
- تأكد أن الملف غير تالف
- جرب نسخة احتياطية أخرى
- تحقق من الإصدار (version)

### مشكلة: "Import failed"
**الحل:**
- تحقق من أسماء الأعمدة
- تأكد من التنسيق الصحيح
- للـ CSV: استخدم UTF-8
- راجع Console للتفاصيل

### مشكلة: البيانات المستوردة "مكررة"
**الحل:**
- استخدمت Mode: Append على بيانات موجودة
- الحل: استخدم Replace بعد نسخ احتياطي
- أو: امسح البيانات المكررة يدوياً

---

## 📊 أفضل الممارسات

### 1. النسخ الاحتياطي المنتظم:
```
✅ يومي: في نهاية كل يوم عمل
✅ أسبوعي: نسخة كاملة نهاية الأسبوع
✅ شهري: نسخة طويلة المدى للأرشيف
✅ قبل التحديثات: دائماً قبل أي تغيير كبير
```

### 2. تنظيم النسخ الاحتياطية:
```
📁 Backups/
  📁 Daily/
    📄 backup_2025-10-09.json
    📄 backup_2025-10-08.json
  📁 Weekly/
    📄 backup_week_40_2025.json
  📁 Monthly/
    📄 backup_october_2025.json
  📁 Before_Updates/
    📄 backup_before_v2.0.json
```

### 3. التحقق من النسخ:
```
✅ افتح الملف للتأكد من صحته
✅ تحقق من الحجم (يجب أن يكون منطقي)
✅ راجع عدد الصفوف
✅ جرب استعادة على قاعدة بيانات تجريبية
```

### 4. الاستيراد الآمن:
```
✅ ابدأ بـ Template
✅ املأ البيانات بدقة
✅ راجع قبل الرفع
✅ ابدأ بعدد صغير للاختبار
✅ استخدم Append للأمان
```

### 5. الحذف الآمن:
```
⚠️ نسخة احتياطية أولاً!
⚠️ تأكد مرتين
⚠️ راجع الجدول الصحيح
⚠️ لا تحذف بيانات الإنتاج بدون سبب
```

---

## 🎯 الخلاصة

### ما تم إنشاؤه:
✅ نظام نسخ احتياطي كامل
✅ نظام استعادة ذكي
✅ إدارة منفردة لكل جدول
✅ تصدير واستيراد متقدم
✅ واجهة احترافية وسهلة
✅ نظام صلاحيات محكم
✅ حماية من الأخطاء

### الملفات الجديدة:
```
lib/databaseManager.ts          - المكتبة الأساسية
lib/backupManager.ts            - النسخ الاحتياطي
components/settings/DatabaseManagement.tsx  - الواجهة الرئيسية
components/settings/TableManager.tsx        - إدارة الجداول
app/(authenticated)/settings/page.tsx       - محدثة
DATABASE_MANAGEMENT_GUIDE.md               - هذا الدليل
```

### الميزات الرئيسية:
- 💾 **Full Backup**: نسخة كاملة في ملف واحد
- 📤 **Smart Restore**: استعادة ذكية مع خيارات
- 🗂️ **Per-Table Management**: إدارة مستقلة لكل جدول
- 📊 **Live Stats**: إحصائيات فورية
- 🔐 **Admin Only**: حماية بنظام الصلاحيات
- 📥 **Export**: JSON & CSV
- 📤 **Import**: JSON & CSV
- 📄 **Templates**: قوالب فارغة للاستيراد
- 🗑️ **Safe Delete**: حذف آمن مع تأكيد
- ⚡ **Fast**: أداء محسن

### الأمان:
- ✅ Admin فقط يمكنه الوصول
- ✅ تأكيد مزدوج للعمليات الخطرة
- ✅ رسائل تحذير واضحة
- ✅ حماية البيانات الحساسة
- ✅ Audit trail في Console

---

## 📞 الدعم

إذا واجهت أي مشاكل:
1. راجع قسم "استكشاف الأخطاء" أعلاه
2. تحقق من Console (F12) للأخطاء
3. راجع Supabase logs
4. تأكد من صلاحيات Admin

---

## 🎉 جاهز للاستخدام!

النظام جاهز ويعمل بشكل كامل! 

**ابدأ الآن:**
1. اذهب إلى Settings
2. اختر Database Management
3. استكشف الواجهة
4. جرب إنشاء نسخة احتياطية
5. استمتع بالتحكم الكامل! 🚀

---

**تاريخ الإنشاء:** 2025-10-09  
**الإصدار:** 1.0.0  
**الحالة:** ✅ جاهز للإنتاج

**تم التطوير بواسطة:** AI Assistant  
**مدعوم بـ:** Next.js 14, Supabase, TypeScript

