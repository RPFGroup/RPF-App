# 🔐 نظام الصلاحيات المتقدم

## ✨ المميزات الجديدة

تم إنشاء نظام صلاحيات شامل ودقيق جداً لإدارة الوصول:

---

## 🎯 الصلاحيات المتاحة

### إجمالي: **39 صلاحية** مقسمة على 7 فئات

#### 1. **Projects** (5 صلاحيات) 📁
- ✅ `projects.view` - عرض المشاريع
- ✅ `projects.create` - إنشاء مشاريع
- ✅ `projects.edit` - تعديل المشاريع
- ✅ `projects.delete` - حذف المشاريع
- ✅ `projects.export` - تصدير المشاريع

#### 2. **BOQ** (6 صلاحيات) 📋
- ✅ `boq.view` - عرض الأنشطة
- ✅ `boq.create` - إنشاء أنشطة
- ✅ `boq.edit` - تعديل الأنشطة
- ✅ `boq.delete` - حذف الأنشطة
- ✅ `boq.approve` - اعتماد الأنشطة
- ✅ `boq.export` - تصدير BOQ

#### 3. **KPI** (5 صلاحيات) 🎯
- ✅ `kpi.view` - عرض المؤشرات
- ✅ `kpi.create` - إنشاء مؤشرات
- ✅ `kpi.edit` - تعديل المؤشرات
- ✅ `kpi.delete` - حذف المؤشرات
- ✅ `kpi.export` - تصدير KPI

#### 4. **Reports** (7 صلاحيات) 📊
- ✅ `reports.view` - عرض التقارير
- ✅ `reports.daily` - التقارير اليومية
- ✅ `reports.weekly` - التقارير الأسبوعية
- ✅ `reports.monthly` - التقارير الشهرية
- ✅ `reports.financial` - التقارير المالية
- ✅ `reports.export` - تصدير التقارير
- ✅ `reports.print` - طباعة التقارير

#### 5. **Users** (5 صلاحيات) 👥
- ✅ `users.view` - عرض المستخدمين
- ✅ `users.create` - إنشاء مستخدمين
- ✅ `users.edit` - تعديل المستخدمين
- ✅ `users.delete` - حذف المستخدمين
- ✅ `users.permissions` - إدارة الصلاحيات

#### 6. **Settings** (6 صلاحيات) ⚙️
- ✅ `settings.view` - عرض الإعدادات
- ✅ `settings.divisions` - إدارة الأقسام
- ✅ `settings.project_types` - إدارة أنواع المشاريع
- ✅ `settings.currencies` - إدارة العملات
- ✅ `settings.activities` - إدارة قوالب الأنشطة
- ✅ `settings.holidays` - إدارة العطل

#### 7. **System** (5 صلاحيات) 🔧
- ✅ `system.import` - استيراد البيانات
- ✅ `system.export` - تصدير بيانات النظام
- ✅ `system.backup` - النسخ الاحتياطي
- ✅ `system.audit` - عرض سجلات التدقيق
- ✅ `system.configure` - تكوين النظام

---

## 👥 الصلاحيات الافتراضية للأدوار

### 1. **Admin** (39 صلاحية - 100%) 🔴
```
✅ جميع الصلاحيات
✅ إدارة كاملة للنظام
✅ لا توجد قيود
```

### 2. **Manager** (24 صلاحية - 62%) 🔵
```
✅ Projects: كل شيء (view, create, edit, delete, export)
✅ BOQ: كل شيء (view, create, edit, delete, approve, export)
✅ KPI: كل شيء (view, create, edit, delete, export)
✅ Reports: كل شيء (view, daily, weekly, monthly, financial, export, print)
✅ Settings: عرض فقط (view)
✅ System: تصدير فقط (export)
❌ Users: لا يوجد
❌ System Management: لا يوجد
```

### 3. **Engineer** (16 صلاحية - 41%) 🟢
```
✅ Projects: عرض وتصدير (view, export)
✅ BOQ: إنشاء وتعديل (view, create, edit, export)
✅ KPI: إنشاء وتعديل (view, create, edit, export)
✅ Reports: عرض وتصدير (view, daily, weekly, monthly, export, print)
✅ Settings: عرض فقط (view)
❌ Delete: لا يوجد حذف
❌ Users: لا يوجد
❌ System: لا يوجد
```

### 4. **Viewer** (9 صلاحيات - 23%) ⚪
```
✅ Projects: عرض فقط (view)
✅ BOQ: عرض فقط (view)
✅ KPI: عرض فقط (view)
✅ Reports: عرض محدود (view, daily, weekly, monthly)
✅ Settings: عرض فقط (view)
❌ Create/Edit/Delete: لا يوجد
❌ Export: لا يوجد
❌ Users: لا يوجد
❌ System: لا يوجد
```

---

## 🔧 المميزات المتقدمة

### 1. **Custom Permissions Mode** 🔑

يمكن للـ Admin تفعيل وضع الصلاحيات المخصصة لأي مستخدم:

```
✅ تجاوز صلاحيات الدور الافتراضية
✅ اختيار صلاحيات محددة بدقة
✅ إضافة صلاحيات إضافية
✅ إزالة صلاحيات معينة
✅ مرونة كاملة
```

**مثال:**
```
Engineer عادي: 16 صلاحية

Engineer مع Custom Permissions:
- يمكن إعطاؤه boq.delete (إضافة)
- يمكن إزالة boq.approve (إزالة)
- النتيجة: 15-17 صلاحية حسب الحاجة
```

### 2. **Active/Inactive Status** ✅❌

تفعيل أو تعطيل المستخدمين بدون حذفهم:

```
Active (نشط):
- ✅ يمكنه تسجيل الدخول
- ✅ يمكنه استخدام النظام
- ✅ صلاحياته فعالة

Inactive (معطّل):
- ❌ لا يمكنه تسجيل الدخول
- ❌ معلق مؤقتاً
- ✅ البيانات محفوظة
- ✅ يمكن إعادة تفعيله لاحقاً
```

**الفائدة:**
- إيقاف مؤقت للمستخدمين
- بدون حذف البيانات
- إمكانية العودة بسهولة

### 3. **Permissions Manager UI** 🖥️

واجهة متقدمة لإدارة الصلاحيات:

```
✅ عرض جميع الصلاحيات مصنفة حسب الفئة
✅ إحصائيات (Total, Create, Edit, Delete)
✅ تفعيل/تعطيل كل صلاحية
✅ Select All / Clear All لكل فئة
✅ Custom Mode toggle
✅ Reset to Role Defaults
✅ مؤشرات بصرية للتغييرات
```

---

## 🎨 واجهة إدارة المستخدمين المحسّنة

### الأعمدة الجديدة:

| العمود | الوصف | المميزات |
|--------|-------|----------|
| **User** | الاسم والإيميل | مع أيقونة |
| **Role** | الدور | badge ملون |
| **Permissions** | عدد الصلاحيات | مع badge "Custom" إن وجد |
| **Division** | القسم | مع أيقونة |
| **Status** | Active/Inactive | قابل للنقر للتغيير |
| **Actions** | الإجراءات | 3 أزرار |

### الأزرار في Actions:

1. **🛡️ Shield** - Manage Permissions
   - يفتح نافذة إدارة الصلاحيات الكاملة
   
2. **✏️ Edit** - Edit User
   - تعديل المعلومات الأساسية
   
3. **🗑️ Delete** - Delete User
   - حذف المستخدم نهائياً

---

## 📋 كيفية الاستخدام

### إعداد أولي (لأول مرة):

#### 1. تطبيق SQL Script:
```sql
-- في Supabase SQL Editor
-- نفذ محتوى الملف:
Database/add-permissions-columns.sql
```

**سيقوم بـ:**
- ✅ إضافة 4 أعمدة جديدة
- ✅ إنشاء فهارس
- ✅ تحديث المستخدمين الحاليين
- ✅ إنشاء دوال مساعدة

---

### استخدام يومي:

#### سيناريو 1: إدارة صلاحيات مستخدم

```
1. افتح /users
2. ابحث عن المستخدم
3. اضغط زر 🛡️ (Shield) في صف المستخدم
4. ستفتح نافذة Permissions Manager:
   
   ┌────────────────────────────────────────┐
   │ Manage Permissions - Ahmed Ali         │
   │ ahmed@company.com • Role: ENGINEER     │
   ├────────────────────────────────────────┤
   │ Default Role: 16 permissions           │
   │                                        │
   │ ☐ Enable Custom Permissions            │
   ├────────────────────────────────────────┤
   │ Statistics:                            │
   │ Total: 16  Create: 4  Edit: 3  Del: 0 │
   ├────────────────────────────────────────┤
   │ PROJECTS (2/5)                         │
   │ ☑ View Projects                        │
   │ ☑ Export Projects                      │
   │ ☐ Create Projects                      │
   │ ☐ Edit Projects                        │
   │ ☐ Delete Projects                      │
   ├────────────────────────────────────────┤
   │ BOQ (4/6)                              │
   │ ☑ View BOQ                             │
   │ ☑ Create Activities                    │
   │ ☑ Edit Activities                      │
   │ ☑ Export BOQ                           │
   │ ☐ Delete Activities                    │
   │ ☐ Approve Activities                   │
   └────────────────────────────────────────┘
   
5. لتخصيص الصلاحيات:
   - ✅ فعّل "Enable Custom Permissions"
   - ✅ اختر/ألغِ الصلاحيات المطلوبة
   - ✅ اضغط Save
```

#### سيناريو 2: إضافة صلاحية إضافية لمهندس

```
المطلوب: إعطاء مهندس معين صلاحية حذف الأنشطة

1. افتح Permissions Manager للمهندس
2. فعّل "Enable Custom Permissions"
3. في قسم BOQ:
   - اضغط على ☐ Delete Activities
   - سيصبح ☑ Delete Activities
4. لاحظ:
   - ظهور badge "Custom" بجانب اسمه
   - العدد تغير من 16 → 17
   - علامة "⚠️ Custom" عند الصلاحية
5. اضغط Save
```

#### سيناريو 3: إيقاف مستخدم مؤقتاً

```
1. في جدول المستخدمين
2. اضغط على badge "Active" في عمود Status
3. سيتحول إلى "Inactive"
4. المستخدم الآن:
   - ❌ لا يمكنه تسجيل الدخول
   - ✅ البيانات محفوظة
   - ✅ يمكن إعادة تفعيله لاحقاً
```

---

## 🔍 الدوال المساعدة

### في الكود:

```typescript
import { hasPermission, canPerformAction } from '@/lib/permissionsSystem'

// التحقق من صلاحية واحدة
if (hasPermission(user, 'projects.create')) {
  // المستخدم يمكنه إنشاء مشاريع
}

// التحقق من إمكانية تنفيذ عملية
if (canPerformAction(user, 'boq', 'delete')) {
  // المستخدم يمكنه حذف أنشطة BOQ
}

// الحصول على العمليات المتاحة
const actions = getAvailableActions(user, 'projects')
// النتيجة: ['view', 'export'] للـ Engineer
```

### في قاعدة البيانات:

```sql
-- التحقق من صلاحية
SELECT user_has_permission(
  '123e4567-e89b-12d3-a456-426614174000'::UUID, 
  'projects.create'
);

-- الحصول على عدد الصلاحيات
SELECT get_user_permissions_count(
  '123e4567-e89b-12d3-a456-426614174000'::UUID
);
```

---

## 📊 مقارنة الأدوار

| الصلاحية | Admin | Manager | Engineer | Viewer |
|----------|-------|---------|----------|--------|
| **Projects** |
| View | ✅ | ✅ | ✅ | ✅ |
| Create | ✅ | ✅ | ❌ | ❌ |
| Edit | ✅ | ✅ | ❌ | ❌ |
| Delete | ✅ | ✅ | ❌ | ❌ |
| Export | ✅ | ✅ | ✅ | ❌ |
| **BOQ** |
| View | ✅ | ✅ | ✅ | ✅ |
| Create | ✅ | ✅ | ✅ | ❌ |
| Edit | ✅ | ✅ | ✅ | ❌ |
| Delete | ✅ | ✅ | ❌ | ❌ |
| Approve | ✅ | ✅ | ❌ | ❌ |
| Export | ✅ | ✅ | ✅ | ❌ |
| **KPI** |
| View | ✅ | ✅ | ✅ | ✅ |
| Create | ✅ | ✅ | ✅ | ❌ |
| Edit | ✅ | ✅ | ✅ | ❌ |
| Delete | ✅ | ✅ | ❌ | ❌ |
| Export | ✅ | ✅ | ✅ | ❌ |
| **Reports** |
| View All | ✅ | ✅ | ✅ | ✅ |
| Financial | ✅ | ✅ | ❌ | ❌ |
| Export | ✅ | ✅ | ✅ | ❌ |
| Print | ✅ | ✅ | ✅ | ❌ |
| **Users** |
| View | ✅ | ❌ | ❌ | ❌ |
| Create | ✅ | ❌ | ❌ | ❌ |
| Edit | ✅ | ❌ | ❌ | ❌ |
| Delete | ✅ | ❌ | ❌ | ❌ |
| Permissions | ✅ | ❌ | ❌ | ❌ |
| **Settings** |
| View | ✅ | ✅ | ✅ | ✅ |
| Manage | ✅ | ❌ | ❌ | ❌ |
| **System** |
| Import | ✅ | ❌ | ❌ | ❌ |
| Export | ✅ | ✅ | ❌ | ❌ |
| Backup | ✅ | ❌ | ❌ | ❌ |
| Audit | ✅ | ❌ | ❌ | ❌ |

**Total:** 39 / 24 / 16 / 9

---

## 🚀 الخطوات للتطبيق

### 1. تطبيق SQL Script

```sql
-- في Supabase Dashboard → SQL Editor
-- نفذ محتوى:
Database/add-permissions-columns.sql
```

**ماذا سيحدث:**
- ✅ إضافة 4 أعمدة جديدة لجدول users
- ✅ تحديث المستخدمين الحاليين
- ✅ إنشاء دوال مساعدة

### 2. اختبار الواجهة

```
1. افتح /users
2. لاحظ العمود الجديد "Permissions"
3. لاحظ العمود الجديد "Status"
4. لاحظ الزر الجديد 🛡️
```

### 3. اختبار إدارة الصلاحيات

```
1. اضغط 🛡️ على أي مستخدم
2. ستفتح نافذة كبيرة مع جميع الصلاحيات
3. راجع الصلاحيات الحالية
4. جرّب Custom Mode
5. اختر صلاحيات مختلفة
6. احفظ وراجع التغييرات
```

---

## 💡 أمثلة عملية

### مثال 1: مهندس موقع متقدم

```
الحاجة: مهندس موقع يحتاج صلاحيات إضافية

الدور الافتراضي (Engineer):
- ✅ 16 صلاحية
- ❌ لا يمكنه حذف أنشطة
- ❌ لا يمكنه إنشاء مشاريع

الحل (Custom Permissions):
1. فعّل Custom Mode
2. أضف:
   - projects.create
   - boq.delete
3. النتيجة: 18 صلاحية
4. الآن يمكنه:
   - ✅ إنشاء مشاريع
   - ✅ حذف أنشطة
```

### مثال 2: مدير قسم محدد

```
الحاجة: مدير لا يحتاج صلاحيات مالية

الدور الافتراضي (Manager):
- ✅ 24 صلاحية
- ✅ يمكنه رؤية التقارير المالية

الحل (Custom Permissions):
1. فعّل Custom Mode
2. احذف:
   - reports.financial
3. النتيجة: 23 صلاحية
4. الآن:
   - ❌ لا يرى التقارير المالية
   - ✅ باقي الصلاحيات كما هي
```

### مثال 3: محاسب (دور خاص)

```
الحاجة: محاسب يحتاج صلاحيات عرض + مالية فقط

الأساس: Viewer (9 صلاحيات)

التخصيص (Custom Permissions):
1. ابدأ من Viewer
2. فعّل Custom Mode
3. أضف:
   - reports.financial
   - reports.export
   - projects.export
4. النتيجة: 12 صلاحية
5. دور مخصص للمحاسب!
```

---

## 🎯 الملخص

النظام الجديد يوفر:

### المرونة:
- ✅ 4 أدوار افتراضية
- ✅ صلاحيات مخصصة لكل مستخدم
- ✅ 39 صلاحية دقيقة
- ✅ 7 فئات منظمة

### التحكم:
- ✅ تفعيل/تعطيل المستخدمين
- ✅ إدارة دقيقة للصلاحيات
- ✅ واجهة سهلة ومرئية
- ✅ تتبع التغييرات

### الأمان:
- ✅ صلاحيات محددة بدقة
- ✅ تفعيل/تعطيل سريع
- ✅ مراجعة سهلة
- ✅ Admin فقط يمكنه التعديل

---

## 📝 الملفات الجديدة

1. ✅ `lib/permissionsSystem.ts` - نظام الصلاحيات الأساسي
2. ✅ `components/users/AdvancedPermissionsManager.tsx` - واجهة إدارة الصلاحيات
3. ✅ `Database/add-permissions-columns.sql` - SQL لإضافة الأعمدة
4. ✅ `نظام_الصلاحيات_المتقدم.md` - هذا الملف (التوثيق)

## 📝 الملفات المعدلة

1. ✅ `components/users/UserManagement.tsx` - دمج النظام الجديد

---

## 🚀 الخطوة التالية

```
1. نفذ SQL Script في Supabase
2. أعد تحميل /users
3. جرّب إدارة الصلاحيات
4. استمتع بالتحكم الدقيق! 🎉
```

---

**نظام صلاحيات متقدم واحترافي! ✅**

